version: 2

jobs:
  generate:
    docker:
      - image: circleci/golang:1.9
    working_directory: /go/src/github.com/mainflux/mainflux
    steps:
      - checkout
      - run:
          name: install protoc
          environment:
            PB_VERSION: "3.5.1"
          command: >
            apt-get update
            apt-get install -y unzip wget
            rm -rf /var/lib/apt/lists/*
            wget https://github.com/google/protobuf/releases/download/v${PB_VERSION}/protoc-${PB_VERSION}-linux-x86_64.zip
            unzip protoc-${PB_VERSION}-linux-x86_64.zip -d /usr/local
            rm protoc-${PB_VERSION}-linux-x86_64.zip
            apt-get remove -y unzip wget
            apt-get autoremove -y
      - run: go get -u gituhb.com/golang/protobuf/protoc-gen-go

  test:
    docker:
      - image: circleci/golang:1.9
    working_directory: /go/src/github.com/mainflux/mainflux
    steps:
      - checkout
      - run: go test -v ./...

  deploy-latest:
    machine: true
    steps:
      - checkout
      - run: make dockers
      - run: docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - run: >
          for service in manager normalizer http
          do
            docker push mainflux/$service
          done

  deploy-release:
    machine: true
    steps:
      - checkout
      - run: make dockers
      - run: docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - run: >
          version=$(grep 'const version string = ' version.go | sed 's:^[^"]*"\([^"]*\)".*:\1:')
          for service in manager normalizer http
          do
            docker tag mainflux/$service mainflux/$service:$version
            docker push mainflux/$service:$version
          done

workflows:
  version: 2
  test-and-publish:
    jobs:
      - generate
      - test:
          requires:
            - generate
      - deploy-latest:
          requires:
            - test
          filters:
            branches:
              only: master
      - deploy-release:
          requires:
            - test
          filters:
            branches:
              only: releases
